---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

const posts = (await getCollection('projects')).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body class="projects-page">
		<Header />
		
		<!-- Hero Section -->
		<header class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
			<div class="mx-auto w-full max-w-[1400px] px-6 py-12">
				<div class="text-center mb-8">
					<h1 class="text-4xl md:text-5xl font-bold text-slate-900 mb-4">
						Educational Projects
					</h1>
					<p class="text-lg text-slate-600 max-w-3xl mx-auto">
						Discover innovative educational resources designed for various learning environments and academic levels
					</p>
				</div>
				
				<!-- Quick stats bar -->
				<div class="flex flex-wrap justify-center gap-8 text-center">
					<div class="flex flex-col">
						<span class="text-2xl font-bold text-blue-600">{posts.length}</span>
						<span class="text-sm text-slate-500">Total Projects</span>
					</div>
					<div class="flex flex-col">
						<span class="text-2xl font-bold text-blue-600" id="active-filters">0</span>
						<span class="text-sm text-slate-500">Active Filters</span>
					</div>
					<div class="flex flex-col">
						<span class="text-2xl font-bold text-blue-600">5</span>
						<span class="text-sm text-slate-500">School Levels</span>
					</div>
				</div>
			</div>
		</header>

		<main class="projects-page-main">
			<div class="mx-auto w-full max-w-[1400px] px-4 py-12">
				<div id="projects-app" data-projects={JSON.stringify(posts)}></div>
			</div>
		</main>
		<Footer />

		<script>
			import { createRoot } from 'react-dom/client';
			import { createElement, useState, useMemo, useCallback, useEffect } from 'react';
			import { HeroUIProvider } from '@heroui/react';
			import ProjectGrid from '../../components/ProjectGrid';
			import ProjectFilters from '../../components/ProjectFilters';
			import ProjectModal from '../../components/ProjectModal';
			import type { CollectionEntry } from 'astro:content';

			function ProjectsApp({ projects }: { projects: CollectionEntry<'projects'>[] }) {
				const [selectedTags, setSelectedTags] = useState<string[]>([]);
				const [selectedProject, setSelectedProject] = useState<CollectionEntry<'projects'> | null>(null);
				const [isModalOpen, setIsModalOpen] = useState(false);
				const [isModalReady, setIsModalReady] = useState(false);

				// Filter projects based on selected tags
				const filteredProjects = useMemo(() => {
					if (selectedTags.length === 0) {
						return projects;
					}

					return projects.filter((project) => {
						const projectTags = project.data.tags || [];
						// Project must have at least one of the selected tags
						return selectedTags.some((tag) =>
							projectTags.some((pt) => pt.toLowerCase() === tag.toLowerCase())
						);
					});
				}, [projects, selectedTags]);

				// Stabilize modal state to prevent race conditions
				useEffect(() => {
					if (isModalOpen && selectedProject) {
						// Small delay to ensure state is fully updated
						const timer = setTimeout(() => {
							setIsModalReady(true);
						}, 50);
						return () => clearTimeout(timer);
					} else {
						setIsModalReady(false);
					}
				}, [isModalOpen, selectedProject]);

				const handleProjectClick = useCallback((project: CollectionEntry<'projects'>) => {
					// Consolidate state updates to prevent race conditions
					setSelectedProject(project);
					// Use a small delay to ensure project state is set before opening modal
					setTimeout(() => {
						setIsModalOpen(true);
					}, 10);
				}, []);

				const handleModalClose = useCallback(() => {
					setIsModalOpen(false);
					// Clear selected project after modal closes to prevent stale state
					setTimeout(() => {
						setSelectedProject(null);
					}, 300);
				}, []);

	
				return createElement(
					HeroUIProvider,
					null,
					createElement('div', { className: 'flex flex-col lg:flex-row gap-10 items-start' }, [
						// Sidebar for filters
						createElement('aside', {
							key: 'sidebar',
							className: 'w-full lg:w-64 lg:flex-none lg:sticky lg:top-10'
						}, [
							createElement(ProjectFilters, {
								key: 'filters',
								onFiltersChange: setSelectedTags,
								availableProjects: projects,
							})
						]),
						
						// Main content area
						createElement('section', {
							key: 'main',
							className: 'flex-1 min-w-0 w-full'
						}, [
							// Results header
							createElement('div', {
								key: 'header',
								className: 'flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4'
							}, [
								createElement('h2', {
									key: 'title',
									className: 'text-2xl font-semibold text-slate-900'
								}, 'Available Projects'),
								createElement('span', {
									key: 'count',
									className: 'text-sm text-slate-600'
								}, `Showing ${filteredProjects.length} of ${projects.length} projects`)
							]),
							
							// Project grid
							createElement(ProjectGrid, {
								key: 'grid',
								projects: filteredProjects,
								onProjectClick: handleProjectClick,
							})
						]),
						
						// Modal
						createElement(ProjectModal, {
							key: 'modal',
							isOpen: isModalReady,
							onClose: handleModalClose,
							project: selectedProject,
						}),
					])
				);
			}

			// Mount the React app
			const appElement = document.getElementById('projects-app');
			if (appElement) {
				const projectsData = JSON.parse(appElement.getAttribute('data-projects') || '[]');
				const root = createRoot(appElement);
				root.render(createElement(ProjectsApp, { projects: projectsData }));
			}
		</script>
	</body>
</html>
