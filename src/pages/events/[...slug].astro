---
import { type CollectionEntry, getCollection, getEntry, render } from 'astro:content';
import EventPost from '../../layouts/EventPost.astro';
import { Icon } from '../../components/ui/Icon.tsx';
import { formatEventDateTimeRange, getEventAudience, getEventDuration, getEventLocation, getEventStatusBadgeProps, getEventStatus } from '../../utils/eventHelpers.ts';
import '../../styles/markdown.css';

export async function getStaticPaths() {
	const events = await getCollection('events');
	console.log('Events in getStaticPaths:', events.map(e => ({ id: e.id, name: e.data.eventName })));
	return events.map((event) => ({
		params: { slug: event.id },
		props: event,
	}));
}

type Props = CollectionEntry<'events'>;

const event = Astro.props;
const { slug } = Astro.params;

console.log('Dynamic route accessed with slug:', slug);
console.log('Event props:', event);

// Handle undefined slug case
if (!slug || slug === 'undefined') {
	console.log('Undefined slug detected, redirecting to /events');
	return Astro.redirect('/events');
}

if (!event) {
	console.log('No event found, redirecting to /events');
	return Astro.redirect('/events');
}

const { Content } = await render(event);
const eventData = event.data;
const eventDateRange = formatEventDateTimeRange(eventData.eventDateStart, eventData.eventDateEnd);
const eventDuration = getEventDuration(eventData.eventDateStart, eventData.eventDateEnd);
const eventLocation = eventData.eventLocation?.trim() || getEventLocation(eventData.eventTags);
const eventAudience = eventData.eventFor?.trim() || getEventAudience(eventData.eventTags);
const currentEventStatus = getEventStatus(eventData.eventDateStart, eventData.eventDateEnd);
const statusBadgeProps = getEventStatusBadgeProps(currentEventStatus);
const featuredTags = eventData.eventTags ? eventData.eventTags.slice(0, 4) : [];
const heroStats = [
	{ icon: 'Calendar', label: 'Date & Time', value: eventDateRange, helper: `â‰ˆ ${eventDuration}` },
	{ icon: 'MapPin', label: 'Location', value: eventLocation, helper: 'Where we meet' },
	{ icon: 'Users', label: 'Audience', value: eventAudience, helper: 'Best suited for' }
];

function getStatusIcon(status: string): string {
	switch (status) {
		case 'upcoming':
			return 'Calendar';
		case 'ongoing':
			return 'PlayCircle';
		case 'completed':
			return 'CheckCircle';
		case 'cancelled':
			return 'XCircle';
		default:
			return 'Calendar';
	}
}

const statusAccent = statusBadgeProps.className.includes('blue')
	? '#2563eb'
	: statusBadgeProps.className.includes('green')
	? '#059669'
	: statusBadgeProps.className.includes('red')
	? '#dc2626'
	: '#475569';
const statusIcon = getStatusIcon(currentEventStatus);
---

<EventPost {...event.data}>
	<section slot="hero" class="event-hero">
		<div class="event-hero__content">
			<div class="event-hero__pill-row">
				<div class="event-hero__pills">
					<span class="event-hero__pill" style={{ color: statusAccent, borderColor: statusAccent + '40', background: statusAccent + '10' }}>
						<Icon icon={statusIcon} size={14} />
						<span class="capitalize">{currentEventStatus}</span>
					</span>
					<span class="event-hero__pill event-hero__pill--muted">
						<Icon icon="Clock" size={12} />
						<span>{eventDuration}</span>
					</span>
				</div>
				<a href="/events" class="event-hero__back-link">
					<Icon icon="ArrowLeft" size={14} />
					<span>All events</span>
				</a>
			</div>
			<div class="event-hero__main">
				<h1 class="event-hero__title">{eventData.eventName}</h1>
				<p class="event-hero__subtitle">{eventData.eventDescription || 'Explore the highlights, schedule, and resources for this event.'}</p>
			</div>
			<div class="event-hero__stat-grid">
				{heroStats.map((stat) => (
					<div class="event-hero__stat-card">
						<Icon icon={stat.icon} size={16} className="event-hero__stat-icon" />
						<div class="event-hero__stat-text">
							<span>{stat.label}</span>
							<strong>{stat.value}</strong>
							<small>{stat.helper}</small>
						</div>
					</div>
				))}
			</div>
			{featuredTags.length > 0 && (
				<div class="event-hero__tags">
					{featuredTags.map((tag) => (
						<span class="event-hero__tag">{tag}</span>
					))}
				</div>
			)}
		</div>
	</section>
	<div class="markdown-content">
		<Content />
	</div>
</EventPost>

	<style>
		.event-hero {
			background: linear-gradient(145deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
			border: 1px solid rgba(148, 163, 184, 0.1);
			border-radius: 12px;
			padding: 1.5rem;
			margin-bottom: 1.5rem;
			box-shadow: 
				0 4px 6px -1px rgba(0, 0, 0, 0.03),
				0 2px 4px -1px rgba(0, 0, 0, 0.02),
				inset 0 1px 0 rgba(255, 255, 255, 0.8);
			position: relative;
			overflow: hidden;
		}

		.event-hero::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 1px;
			background: linear-gradient(90deg, 
				transparent 0%, 
				rgba(59, 130, 246, 0.2) 20%, 
				rgba(139, 92, 246, 0.2) 50%, 
				rgba(236, 72, 153, 0.2) 80%, 
				transparent 100%);
		}

		.event-hero__content {
			display: flex;
			flex-direction: column;
			gap: 1.25rem;
			position: relative;
		}

		.event-hero__pill-row {
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 0.75rem;
			flex-wrap: wrap;
			padding-bottom: 0.875rem;
			border-bottom: 1px solid rgba(148, 163, 184, 0.1);
		}

		.event-hero__pills {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
		}

		.event-hero__pill {
			display: inline-flex;
			align-items: center;
			gap: 0.375rem;
			padding: 0.5rem 0.875rem;
			border-radius: 8px;
			font-size: 0.75rem;
			font-weight: 600;
			border: 1px solid rgba(0, 0, 0, 0.08);
			background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
			box-shadow: 
				0 2px 4px rgba(0, 0, 0, 0.04),
				inset 0 1px 0 rgba(255, 255, 255, 0.6);
			backdrop-filter: blur(8px);
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
		}

		.event-hero__pill:hover {
			transform: translateY(-1px);
			box-shadow: 
				0 4px 8px rgba(0, 0, 0, 0.08),
				inset 0 1px 0 rgba(255, 255, 255, 0.8);
		}

		.event-hero__pill--muted {
			color: #475569;
			background: linear-gradient(145deg, rgba(148, 163, 184, 0.12) 0%, rgba(100, 116, 139, 0.08) 100%);
			border-color: rgba(148, 163, 184, 0.2);
		}

		.event-hero__back-link {
			display: inline-flex;
			align-items: center;
			gap: 0.375rem;
			font-size: 0.8125rem;
			font-weight: 600;
			color: #1e293b;
			text-decoration: none;
			padding: 0.5rem 0.875rem;
			background: linear-gradient(145deg, rgba(248, 250, 252, 0.8) 0%, rgba(241, 245, 249, 0.8) 100%);
			border: 1px solid rgba(148, 163, 184, 0.15);
			border-radius: 8px;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 
				0 1px 3px rgba(0, 0, 0, 0.04),
				inset 0 1px 0 rgba(255, 255, 255, 0.6);
		}

		.event-hero__back-link:hover {
			background: linear-gradient(145deg, rgba(241, 245, 249, 0.9) 0%, rgba(226, 232, 240, 0.9) 100%);
			transform: translateY(-1px);
			box-shadow: 
				0 4px 6px rgba(0, 0, 0, 0.08),
				inset 0 1px 0 rgba(255, 255, 255, 0.8);
			color: #0f172a;
		}

		.event-hero__main {
			display: flex;
			flex-direction: column;
			gap: 0.875rem;
		}

		.event-hero__title {
			font-size: 2.25rem;
			font-weight: 700;
			line-height: 1.1;
			letter-spacing: -0.025em;
			margin: 0;
			background: linear-gradient(135deg, #0f172a 0%, #1e293b 40%, #475569 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			text-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
		}

		.event-hero__subtitle {
			margin: 0;
			font-size: 1rem;
			line-height: 1.5;
			color: #64748b;
			max-width: 65ch;
			font-weight: 400;
		}

		.event-hero__stat-grid {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 0.75rem;
		}

		.event-hero__stat-card {
			display: flex;
			align-items: flex-start;
			gap: 0.625rem;
			padding: 0.875rem;
			background: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
			border: 1px solid rgba(148, 163, 184, 0.08);
			border-radius: 10px;
			min-height: 3.25rem;
			box-shadow: 
				0 2px 4px rgba(0, 0, 0, 0.04),
				0 1px 2px rgba(0, 0, 0, 0.02),
				inset 0 1px 0 rgba(255, 255, 255, 0.8);
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			backdrop-filter: blur(4px);
		}
		
		.event-hero__stat-card:hover {
			transform: translateY(-2px);
			box-shadow: 
				0 8px 16px rgba(0, 0, 0, 0.08),
				0 4px 8px rgba(0, 0, 0, 0.04),
				inset 0 1px 0 rgba(255, 255, 255, 0.9);
			border-color: rgba(148, 163, 184, 0.15);
		}

		.event-hero__stat-icon {
			width: 16px;
			height: 16px;
			opacity: 0.7;
			flex-shrink: 0;
			margin-top: 2px;
		}

		.event-hero__stat-text {
			display: flex;
			flex-direction: column;
			gap: 0.125rem;
			min-width: 0;
		}

		.event-hero__stat-text span {
			font-size: 0.625rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.075em;
			opacity: 0.6;
			line-height: 1;
		}

		.event-hero__stat-text strong {
			font-size: 0.8125rem;
			font-weight: 600;
			line-height: 1.3;
			overflow: hidden;
			text-overflow: ellipsis;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			word-break: break-word;
			color: #1e293b;
		}

		.event-hero__stat-text small {
			font-size: 0.6875rem;
			color: #64748b;
			font-weight: 400;
		}

		.event-hero__tags {
			display: flex;
			flex-wrap: wrap;
			gap: 0.375rem;
			padding-top: 0.875rem;
			border-top: 1px solid rgba(148, 163, 184, 0.1);
		}

		.event-hero__tag {
			padding: 0.3125rem 0.625rem;
			border-radius: 6px;
			font-size: 0.6875rem;
			font-weight: 500;
			background: linear-gradient(145deg, rgba(248, 250, 252, 0.8) 0%, rgba(241, 245, 249, 0.8) 100%);
			border: 1px solid rgba(148, 163, 184, 0.15);
			color: #475569;
			transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
			box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
		}
		
		.event-hero__tag:hover {
			background: linear-gradient(145deg, rgba(59, 130, 246, 0.08) 0%, rgba(37, 99, 235, 0.04) 100%);
			border-color: rgba(59, 130, 246, 0.3);
			transform: translateY(-1px);
			box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
			color: #1e40af;
		}

		@media (max-width: 1024px) {
			.event-hero {
				padding: 1.25rem;
			}

			.event-hero__content {
				gap: 1rem;
			}

			.event-hero__title {
				font-size: 2rem;
			}

			.event-hero__subtitle {
				font-size: 0.9375rem;
			}

			.event-hero__stat-grid {
				grid-template-columns: 1fr;
				gap: 0.625rem;
			}

			.event-hero__stat-card {
				min-height: 3rem;
				padding: 0.75rem;
			}

			.event-hero__tags {
				gap: 0.3125rem;
			}

			.event-hero__tag {
				font-size: 0.65625rem;
			}
		}

		@media (max-width: 768px) {
			.event-hero {
				padding: 1rem;
			}
			
			.event-hero__content {
				gap: 0.875rem;
			}

			.event-hero__pill-row {
				padding-bottom: 0.75rem;
				gap: 0.5rem;
			}

			.event-hero__pill {
				padding: 0.375rem 0.6875rem;
				font-size: 0.6875rem;
			}

			.event-hero__back-link {
				padding: 0.375rem 0.6875rem;
				font-size: 0.75rem;
			}

			.event-hero__title {
				font-size: 1.75rem;
			}
			
			.event-hero__subtitle {
				font-size: 0.875rem;
			}
			
			.event-hero__stat-grid {
				gap: 0.5rem;
			}
			
			.event-hero__stat-card {
				padding: 0.625rem;
				min-height: 2.75rem;
			}

			.event-hero__stat-icon {
				width: 15px;
				height: 15px;
			}

			.event-hero__stat-text strong {
				font-size: 0.78125rem;
			}

			.event-hero__stat-text small {
				font-size: 0.65625rem;
			}

			.event-hero__tags {
				padding-top: 0.75rem;
				gap: 0.25rem;
			}
			
			.event-hero__tag {
				padding: 0.25rem 0.5rem;
				font-size: 0.625rem;
			}
		}

		@media (max-width: 640px) {
			.event-hero {
				padding: 0.875rem;
				border-radius: 10px;
			}

			.event-hero__content {
				gap: 0.75rem;
			}

			.event-hero__pill-row {
				flex-direction: column;
				align-items: flex-start;
				gap: 0.5rem;
				padding-bottom: 0.625rem;
			}

			.event-hero__pills {
				gap: 0.375rem;
			}

			.event-hero__pill {
				padding: 0.3125rem 0.625rem;
				font-size: 0.65625rem;
			}

			.event-hero__back-link {
				width: fit-content;
				padding: 0.3125rem 0.625rem;
				font-size: 0.71875rem;
			}

			.event-hero__title {
				font-size: 1.5rem;
				line-height: 1.15;
			}

			.event-hero__subtitle {
				font-size: 0.8125rem;
			}
			
			.event-hero__stat-grid {
				gap: 0.375rem;
			}
			
			.event-hero__stat-card {
				padding: 0.5rem;
				min-height: 2.5rem;
				gap: 0.5rem;
			}
			
			.event-hero__stat-icon {
				width: 14px;
				height: 14px;
			}
			
			.event-hero__stat-text strong {
				font-size: 0.75rem;
			}

			.event-hero__stat-text small {
				font-size: 0.625rem;
			}
			
			.event-hero__tags {
				padding-top: 0.625rem;
			}
			
			.event-hero__tag {
				padding: 0.1875rem 0.4375rem;
				font-size: 0.59375rem;
			}
		}
	</style>
