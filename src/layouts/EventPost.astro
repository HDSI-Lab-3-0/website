---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/layout/BaseHead.astro';
import Footer from '../components/layout/Footer.astro';
import FormattedDate from '../components/ui/FormattedDate.astro';
import Header from '../components/layout/Header.astro';
import { Icon } from '../components/ui/Icon.tsx';
import tagsData from '../data/tags.json';
import tableOfContentsScript from '../scripts/table-of-contents.js?url';
import headingAnchorsScript from '../scripts/heading-anchors.js?url';
import copyCodeScript from '../scripts/copy-code.js?url';
import { formatEventDateTimeRange, getEventDuration, getEventStatusBadgeProps, getEventLocation, getEventAudience, getEventStatus } from '../utils/eventHelpers.ts';

type Props = CollectionEntry<'events'>['data'] & {
	showTitle?: boolean;
	showTOC?: boolean;
};

const { eventName, eventDescription, eventDateStart, eventDateEnd, eventStatus, eventLocation, eventFor, eventImage, imageGif, eventTags, showTitle = true, showTOC = true } = Astro.props;
const hasHeroSlot = Astro.slots.has('hero');

// Get status color and icon from utility functions
const currentEventStatus = getEventStatus(eventDateStart, eventDateEnd);
const statusBadgeProps = getEventStatusBadgeProps(currentEventStatus);
const resolvedEventLocation = eventLocation?.trim() || getEventLocation(eventTags);
const resolvedEventAudience = eventFor?.trim() || getEventAudience(eventTags);
const eventDateRange = formatEventDateTimeRange(eventDateStart, eventDateEnd);
const eventDuration = getEventDuration(eventDateStart, eventDateEnd);
const heroVisual = imageGif || eventImage;

// Get status icon
function getStatusIcon(status: string): string {
	switch (status) {
		case 'upcoming':
			return 'Calendar';
		case 'ongoing':
			return 'PlayCircle';
		case 'completed':
			return 'CheckCircle';
		case 'cancelled':
			return 'XCircle';
		default:
			return 'Calendar';
	}
}

// Get icon for each category
function getCategoryIcon(category: string): string {
	switch (category) {
		case 'Location':
			return 'MapPin';
		case 'School Level':
			return 'GraduationCap';
		case 'Sponsor':
			return 'Building';
		case 'Cost':
			return 'DollarSign';
		case 'Type':
			return 'Tag';
		default:
			return 'MoreHorizontal';
	}
}

// Categorize tags based on tags.json
function categorizeTags(eventTags: string[] | undefined) {
	if (!eventTags || eventTags.length === 0) return {};
	
	const categorized: Record<string, string[]> = {};
	const usedTags = new Set<string>();
	
	// Check each tag against all categories
	for (const [category, categoryTags] of Object.entries(tagsData.categories)) {
		const matchingTags = eventTags.filter(tag =>
			categoryTags.some(catTag => catTag.toLowerCase() === tag.toLowerCase())
		);
		
		if (matchingTags.length > 0) {
			categorized[category] = matchingTags;
			matchingTags.forEach(tag => usedTags.add(tag.toLowerCase()));
		}
	}
	
	// Add remaining tags to "Other" category
	const otherTags = eventTags.filter(tag => !usedTags.has(tag.toLowerCase()));
	if (otherTags.length > 0) {
		categorized['Other'] = otherTags;
	}
	
	return categorized;
}

// Flatten all tags with their categories for unified display
function getAllTagsWithCategories(eventTags: string[] | undefined) {
	if (!eventTags || eventTags.length === 0) return [];
	
	const categorized = categorizeTags(eventTags);
	const allTags: Array<{ tag: string; category: string; icon: string }> = [];
	
	for (const [category, categoryTags] of Object.entries(categorized)) {
		for (const tag of categoryTags) {
			allTags.push({
				tag,
				category,
				icon: getCategoryIcon(category)
			});
		}
	}
	
	return allTags;
}

const allTagsWithCategories = getAllTagsWithCategories(eventTags);
const statusIcon = getStatusIcon(currentEventStatus);
const statusColor = statusBadgeProps.className.includes('blue') ? '#2563eb' :
                   statusBadgeProps.className.includes('green') ? '#059669' :
                   statusBadgeProps.className.includes('red') ? '#dc2626' : '#475569';
---

<html lang="en">
	<head>
		<BaseHead title={eventName} description={eventDescription} />
		<style>
			/* Document-style layout - clean, simple, light mode only */
			:root {
				--paper-bg: #fefdfb;
				--paper-border: #e8e6e1;
				--text-primary: #1a1a1a;
				--text-secondary: #5c5c5c;
				--text-muted: #8a8a8a;
				--accent-underline: #2563eb;
				--divider: #e5e5e5;
			}

			body {
				background: #f8f7f5;
			}

			/* Main container */
			.doc-container {
				max-width: 1400px;
				margin: 0 auto;
				padding: 2rem 1.5rem;
			}

			.doc-wrapper {
				display: flex;
				gap: 3rem;
				align-items: flex-start;
			}

			/* Table of Contents */
			.doc-toc {
				flex-shrink: 0;
				width: 220px;
				position: sticky;
				top: 6rem;
			}

			.doc-toc-inner {
				font-size: 0.8125rem;
				color: var(--text-secondary);
			}

			.doc-toc-title {
				font-size: 0.6875rem;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.08em;
				color: var(--text-muted);
				margin-bottom: 1rem;
				padding-bottom: 0.5rem;
				border-bottom: 1px solid var(--divider);
			}

			/* Main content area */
			.doc-main {
				flex: 1;
				min-width: 0;
				max-width: 960px;
			}

			.doc-paper {
				background: var(--paper-bg);
				border: 1px solid var(--paper-border);
				border-radius: 4px;
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
			}

			/* Hero image */
			.doc-hero {
				border-bottom: 1px solid var(--paper-border);
			}

			.doc-hero img {
				width: 100%;
				height: auto;
				display: block;
			}

			/* Document header */
			.doc-header {
				padding: 2.5rem 3rem 2rem;
				border-bottom: 1px solid var(--divider);
			}

			.doc-title {
				font-family: "Atkinson", -apple-system, BlinkMacSystemFont, "Georgia", serif;
				font-size: 2.25rem;
				font-weight: 700;
				line-height: 1.2;
				color: var(--text-primary);
				margin: 0 0 1rem;
				letter-spacing: -0.02em;
			}

			.doc-meta {
				display: flex;
				flex-wrap: wrap;
				align-items: center;
				gap: 0.5rem 1rem;
				font-size: 0.8125rem;
				color: var(--text-secondary);
				margin-bottom: 1.25rem;
			}

			.doc-meta-item {
				display: flex;
				align-items: center;
				gap: 0.35rem;
			}

			.doc-meta-divider {
				color: var(--text-muted);
			}

			/* Event status badge */
			.doc-status-badge {
				display: inline-flex;
				align-items: center;
				gap: 0.25rem;
				padding: 0.25rem 0.625rem;
				border-radius: 3px;
				font-size: 0.6875rem;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			/* Event details grid */
			.doc-event-details {
				display: grid;
				grid-template-columns: repeat(3, 1fr);
				gap: 1rem;
				margin-bottom: 1.25rem;
				padding-bottom: 1.25rem;
				border-bottom: 1px solid var(--divider);
			}

			.doc-event-detail {
				display: flex;
				flex-direction: column;
				gap: 0.25rem;
			}

			.doc-event-detail-label {
				font-size: 0.6875rem;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.08em;
				color: var(--text-muted);
			}

			.doc-event-detail-value {
				font-size: 0.875rem;
				color: var(--text-primary);
				line-height: 1.4;
			}

			/* Tags */
			.doc-tags {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
			}

			.doc-tag {
				display: inline-flex;
				align-items: center;
				gap: 0.35rem;
				padding: 0.35rem 0.75rem;
				background: #f5f5f4;
				border: 1px solid #e7e5e4;
				border-radius: 3px;
				font-size: 0.75rem;
				color: var(--text-secondary);
				transition: all 0.15s ease;
			}

			.doc-tag:hover {
				background: #ebebe9;
				border-color: #d6d3d1;
			}

			.doc-tag svg {
				width: 12px;
				height: 12px;
				opacity: 0.6;
			}

			/* Content area */
			.doc-content {
				padding: 2rem 3rem 3rem;
			}

			/* Back link */
			.doc-back-link {
				display: inline-flex;
				align-items: center;
				gap: 0.35rem;
				font-size: 0.8125rem;
				color: var(--text-secondary);
				text-decoration: none;
				margin-bottom: 1.5rem;
				transition: color 0.15s ease;
			}

			.doc-back-link:hover {
				color: var(--text-primary);
			}

			/* Responsive */
			@media (max-width: 1024px) {
				.doc-wrapper {
					flex-direction: column;
				}

				.doc-toc {
					position: static;
					width: 100%;
					margin-bottom: 1.5rem;
				}

				.doc-toc-inner {
					display: none;
				}

				.doc-main {
					max-width: 100%;
				}

				.doc-event-details {
					grid-template-columns: 1fr;
					gap: 0.75rem;
				}
			}

			@media (max-width: 768px) {
				.doc-container {
					padding: 1rem;
				}

				.doc-header {
					padding: 1.5rem 1.25rem 1.5rem;
				}

				.doc-title {
					font-size: 1.75rem;
				}

				.doc-content {
					padding: 1.5rem 1.25rem 2rem;
				}

				.doc-meta {
					font-size: 0.75rem;
				}

				.doc-event-details {
					grid-template-columns: 1fr;
				}
			}

			@media (max-width: 480px) {
				.doc-title {
					font-size: 1.5rem;
				}

				.doc-header {
					padding: 1.25rem 1rem 1.25rem;
				}

				.doc-content {
					padding: 1.25rem 1rem 1.5rem;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		
		<main class="doc-container">
			<article>
				<div class="doc-wrapper">
					{showTOC && (
						<aside class="doc-toc">
							<div class="doc-toc-inner">
								<div class="table-of-contents">
									<div class="toc-header">
										<span class="doc-toc-title">Contents</span>
									</div>
									<div class="toc-content">
										<!-- Table of contents will be generated by JavaScript -->
									</div>
								</div>
							</div>
						</aside>
					)}
					
					<div class="doc-main">
						<div class="doc-paper">
							{heroVisual && (
								<div class="doc-hero">
									<Image width={960} height={480} src={heroVisual} alt={eventName} />
								</div>
							)}
							
							<header class="doc-header">
								<a href="/events" class="doc-back-link">
									<Icon icon="ArrowLeft" size={14} />
									<span>All events</span>
								</a>
								
								{showTitle && <h1 class="doc-title">{eventName}</h1>}
								
								<div class="doc-meta">
									<span class="doc-status-badge" style={{ backgroundColor: statusColor + '15', color: statusColor }}>
										<Icon icon={statusIcon} size={12} />
										<span class="capitalize">{currentEventStatus}</span>
									</span>
									<span class="doc-meta-divider">Â·</span>
									<span class="doc-meta-item">{eventDuration}</span>
								</div>

								<div class="doc-event-details">
									<div class="doc-event-detail">
										<span class="doc-event-detail-label">Date & Time</span>
										<span class="doc-event-detail-value">{eventDateRange}</span>
									</div>
									<div class="doc-event-detail">
										<span class="doc-event-detail-label">Location</span>
										<span class="doc-event-detail-value">{resolvedEventLocation}</span>
									</div>
									<div class="doc-event-detail">
										<span class="doc-event-detail-label">Audience</span>
										<span class="doc-event-detail-value">{resolvedEventAudience}</span>
									</div>
								</div>

								{allTagsWithCategories.length > 0 && (
									<div class="doc-tags">
										{allTagsWithCategories.map((tagInfo) => (
											<span class="doc-tag">
												<Icon icon={tagInfo.icon} size={12} />
												{tagInfo.tag}
											</span>
										))}
									</div>
								)}
							</header>

							<div class="doc-content markdown-content">
								<slot />
							</div>
						</div>
					</div>
				</div>
			</article>
		</main>
		
		<Footer />
		
		{showTOC && <script type="module" is:inline src={tableOfContentsScript}></script>}
		<script type="module" is:inline src={headingAnchorsScript}></script>
		<script type="module" is:inline src={copyCodeScript}></script>
		<script is:inline define:vars={{ eventName: eventName }}>
			document.addEventListener('DOMContentLoaded', () => {
				// Remove redundant H1 if it matches the page title
				const markdownContent = document.querySelector('.markdown-content');
				if (markdownContent) {
					const firstH1 = markdownContent.querySelector('h1');
					if (firstH1 && firstH1.textContent.trim().toLowerCase() === eventName.toLowerCase()) {
						firstH1.remove();
					}
				}
			});
		</script>
	</body>
</html>
