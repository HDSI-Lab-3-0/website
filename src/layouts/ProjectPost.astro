---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/layout/BaseHead.astro';
import Footer from '../components/layout/Footer.astro';
import FormattedDate from '../components/ui/FormattedDate.astro';
import Header from '../components/layout/Header.astro';
import { Icon } from '../components/ui/Icon.tsx';
import tagsData from '../data/tags.json';
import tableOfContentsScript from '../scripts/table-of-contents.js?url';
import headingAnchorsScript from '../scripts/heading-anchors.js?url';
import copyCodeScript from '../scripts/copy-code.js?url';

type Props = CollectionEntry<'projects'>['data'];

const { title, description, pubDate, updatedDate, heroImage, imageGif, links, relevance, tags, estimated_time } = Astro.props;

// Get icon for each category
function getCategoryIcon(category: string): string {
	switch (category) {
		case 'Location':
			return 'MapPin';
		case 'School Level':
			return 'GraduationCap';
		case 'Sponsor':
			return 'Building';
		case 'Cost':
			return 'DollarSign';
		case 'Type':
			return 'Tag';
		default:
			return 'MoreHorizontal';
	}
}

// Get color for each category
function getCategoryColor(category: string): string {
	switch (category) {
		case 'Location':
			return '#10b981'; // emerald-500
		case 'School Level':
			return '#3b82f6'; // blue-500
		case 'Sponsor':
			return '#8b5cf6'; // violet-500
		case 'Cost':
			return '#f59e0b'; // amber-500
		case 'Type':
			return '#ef4444'; // red-500
		default:
			return '#6b7280'; // gray-500
	}
}

// Categorize tags based on tags.json
function categorizeTags(projectTags: string[] | undefined) {
	if (!projectTags || projectTags.length === 0) return {};
	
	const categorized: Record<string, string[]> = {};
	const usedTags = new Set<string>();
	
	// Check each tag against all categories
	for (const [category, categoryTags] of Object.entries(tagsData.categories)) {
		const matchingTags = projectTags.filter(tag =>
			categoryTags.some(catTag => catTag.toLowerCase() === tag.toLowerCase())
		);
		
		if (matchingTags.length > 0) {
			categorized[category] = matchingTags;
			matchingTags.forEach(tag => usedTags.add(tag.toLowerCase()));
		}
	}
	
	// Add remaining tags to "Other" category
	const otherTags = projectTags.filter(tag => !usedTags.has(tag.toLowerCase()));
	if (otherTags.length > 0) {
		categorized['Other'] = otherTags;
	}
	
	return categorized;
}

// Flatten all tags with their categories for unified display
function getAllTagsWithCategories(projectTags: string[] | undefined) {
	if (!projectTags || projectTags.length === 0) return [];
	
	const categorized = categorizeTags(projectTags);
	const allTags: Array<{ tag: string; category: string; icon: string; color: string }> = [];
	
	for (const [category, categoryTags] of Object.entries(categorized)) {
		for (const tag of categoryTags) {
			allTags.push({
				tag,
				category,
				icon: getCategoryIcon(category),
				color: getCategoryColor(category)
			});
		}
	}
	
	return allTags;
}

const allTagsWithCategories = getAllTagsWithCategories(tags);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			main {
				width: calc(100% - 2em);
				max-width: 100%;
				margin: 0;
			}
			.hero-image {
				width: 100%;
				margin-bottom: 2.5rem;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: var(--box-shadow);
			}
			
			/* Layout with sidebar for TOC */
			.content-wrapper {
				display: flex;
				gap: 3rem;
				max-width: 1400px;
				margin: 0 auto;
				position: relative;
				padding: 2rem 1rem;
			}
			
			.toc-sidebar {
				flex-shrink: 0;
				width: 250px;
				order: -1; /* Move TOC to the left */
			}
			
			.main-content {
				flex: 1;
				min-width: 0;
				order: 1; /* Content on the right */
				overflow: hidden;
			}
			
			.prose {
				width: 800px;
				max-width: calc(100% - 2em);
				margin: auto;
				padding: 2em 1em;
				color: rgb(var(--gray-dark));
			}
			
			/* Match responsive breakpoints with markdown-content */
			@media (min-width: 1200px) {
				.prose {
					width: 900px;
					padding: 2.5em 1.5em;
				}
			}
			
			@media (min-width: 1600px) {
				.prose {
					width: 1000px;
					padding: 3em 2em;
				}
			}
			
			/* Responsive layout adjustments */
			@media (max-width: 1024px) {
				.content-wrapper {
					flex-direction: column;
					gap: 2rem;
					padding: 1.5rem 1rem;
				}
				
				.toc-sidebar {
					width: 100%;
					order: 1; /* Show TOC after content on mobile */
				}
				
				.main-content {
					order: -1; /* Show content first on mobile */
				}
				
				.prose {
					padding: 1.5em 1em;
				}
			}
			
			@media (max-width: 768px) {
				.content-wrapper {
					padding: 1rem 0.5rem;
				}
				
				.prose {
					padding: 1em 0.5em;
				}
			}
			.title {
				margin-bottom: 2em;
				padding: 1.5em 0;
				text-align: center;
				line-height: 1.2;
			}
			.title h1 {
				margin: 0 0 0.75em 0;
				font-size: 2.5rem;
				line-height: 1.1;
			}
			
			@media (max-width: 768px) {
				.title h1 {
					font-size: 2rem;
				}
			}
			
			@media (max-width: 480px) {
				.title {
					padding: 1em 0;
					margin-bottom: 1.5em;
				}
				.title h1 {
					font-size: 1.75rem;
				}
			}
			.date {
				margin-bottom: 0.75em;
				color: rgb(var(--gray));
				font-size: 0.95rem;
				line-height: 1.6;
			}
			.last-updated-on {
				font-style: italic;
				margin-top: 0.5em;
				font-size: 0.9rem;
			}
			.gif-image {
				width: 100%;
				margin: 2.5em 0;
			}
			.gif-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: var(--box-shadow);
			}
			.links {
				margin: 2em 0;
				padding: 1.5em;
				background: rgba(var(--accent-light), 0.1);
				border-radius: 12px;
				border: 1px solid rgba(var(--accent), 0.1);
			}
			.links h2 {
				margin-top: 0;
				margin-bottom: 1em;
				font-size: 1.3em;
				color: rgb(var(--black));
			}
			.links ul {
				list-style: none;
				padding: 0;
				margin: 0;
			}
			.links li {
				margin: 0.75em 0;
			}
			.links li:last-child {
				margin-bottom: 0;
			}
			.links a {
				color: rgb(var(--accent));
				text-decoration: none;
			}
			.links a:hover {
				text-decoration: underline;
			}
			.relevance {
				margin: 1.5em 0;
				padding: 1em;
				background: rgba(var(--gray-light), 0.1);
				border-radius: 8px;
				font-style: italic;
			}
			.relevance h2 {
				margin-top: 0;
				font-size: 1.2em;
				font-style: normal;
			}
			.tags-section {
				margin: 2.5em 0;
				padding: 1.5em 0;
				border-top: 1px solid rgba(var(--gray-light), 0.5);
			}
			.tags-header {
				display: flex;
				align-items: center;
				margin-bottom: 1.5em;
				gap: 0.5em;
			}
			.tags-header h2 {
				margin: 0;
				font-size: 1.25em;
				font-weight: 600;
				color: rgb(var(--gray-dark));
			}
			.tags-container {
				display: flex;
				flex-wrap: wrap;
				gap: 0.75em;
				margin-top: 0.5em;
			}
			.tag-item {
				display: inline-flex;
				align-items: center;
				gap: 0.4em;
				padding: 0.4em 0.9em;
				background: rgba(var(--gray-light), 0.15);
				border: 1px solid rgba(var(--gray), 0.15);
				border-radius: 9999px;
				font-size: 0.9em;
				font-weight: 500;
				color: rgb(var(--gray-dark));
				transition: all 0.2s ease;
			}
			.tag-item:hover {
				background: rgba(var(--gray-light), 0.3);
				transform: translateY(-1px);
				box-shadow: 0 2px 4px rgba(var(--gray), 0.1);
			}
			.tag-icon {
				flex-shrink: 0;
				opacity: 0.8;
			}
			.tag-text {
				white-space: nowrap;
			}
			.tag-divider {
				width: 1px;
				height: 1em;
				background: rgba(var(--gray), 0.2);
				margin: 0 0.25em;
			}
			.tag-category-label {
				font-size: 0.75em;
				opacity: 0.7;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}
			
			/* Responsive design for tags */
			@media (max-width: 768px) {
				.tags-section {
					margin: 2em 0;
					padding: 1em 0;
				}
				.tags-container {
					gap: 0.5em;
				}
				.tag-item {
					font-size: 0.85em;
					padding: 0.35em 0.75em;
				}
			}
			
			@media (max-width: 480px) {
				.tags-container {
					gap: 0.4em;
				}
				.tag-item {
					font-size: 0.8em;
					padding: 0.3em 0.65em;
				}
				.tag-category-label {
					display: none;
				}
			}
			.time-indicators {
				margin: 1.5em 0;
				display: flex;
				flex-wrap: wrap;
				gap: 0.75em;
				align-items: center;
			}
			.estimated-time-tag {
				display: inline-flex;
				align-items: center;
				gap: 0.4em;
				padding: 0.5em 1em;
				background: rgba(var(--accent), 0.1);
				border: 1px solid rgba(var(--accent), 0.3);
				border-radius: 9999px;
				font-size: 0.9em;
				font-weight: 500;
				color: var(--accent);
				transition: all 0.2s ease;
			}
			.estimated-time-tag:hover {
				background: rgba(var(--accent), 0.15);
				transform: translateY(-1px);
				box-shadow: 0 2px 4px rgba(var(--accent), 0.2);
			}
			.reading-time {
				display: inline-flex;
				align-items: center;
				gap: 0.4em;
				padding: 0.5em 1em;
				background: rgba(var(--gray-light), 0.15);
				border: 1px solid rgba(var(--gray), 0.2);
				border-radius: 9999px;
				font-size: 0.9em;
				font-weight: 500;
				color: rgb(var(--gray-dark));
			}
			.time-icon {
				flex-shrink: 0;
				opacity: 0.9;
			}
		</style>
	</head>

	<body>
		<Header />
		<!-- Reading Progress Bar -->
		<div class="reading-progress" id="reading-progress"></div>
		
		<main>
			<article>
				<div class="content-wrapper">
					<aside class="toc-sidebar">
						<div class="table-of-contents">
							<div class="toc-header">
								<span class="toc-title">Contents</span>
							</div>
							<div class="toc-content">
								<!-- Table of contents will be generated by JavaScript -->
							</div>
						</div>
					</aside>
					<div class="main-content">
						<div class="prose">
							<div class="hero-image">
								{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
							</div>
							{imageGif && (
								<div class="gif-image">
									<Image width={1020} height={510} src={imageGif} alt="" />
								</div>
							)}
							<div class="title">
								<div class="date">
									<FormattedDate date={pubDate} />
									{
										updatedDate && (
											<div class="last-updated-on">
												Last updated on <FormattedDate date={updatedDate} />
											</div>
										)
									}
								</div>
								<h1>{title}</h1>
								<hr />
								{links && (links.lessonPlan || links.materials) && (
									<div class="links">
										<h2>Resources</h2>
										<ul>
											{links.lessonPlan && (
												<li>
													<a href={links.lessonPlan} target="_blank" rel="noopener noreferrer">
														<Icon icon="FileText" size={16} style={{ display: 'inline', marginRight: '0.5em' }} /> Lesson Plan
													</a>
												</li>
											)}
											{links.materials && (
												<li>
													<a href={links.materials} target="_blank" rel="noopener noreferrer">
														<Icon icon="Package" size={16} style={{ display: 'inline', marginRight: '0.5em' }} /> Materials
													</a>
												</li>
											)}
										</ul>
									</div>
								)}
								{relevance && (
									<div class="relevance">
										<h2>Relevance</h2>
										<p>{relevance}</p>
									</div>
								)}
								{allTagsWithCategories && allTagsWithCategories.length > 0 && (
									<div class="tags-section">
										<div class="tags-header">
											<Icon icon="Tag" size={20} className="tag-icon" style={{ color: 'rgb(var(--gray))' }} />
											<h2>Tags</h2>
										</div>
										<div class="tags-container">
											{allTagsWithCategories.map((tagInfo) => (
												<div class="tag-item" style={{ borderColor: tagInfo.color + '40', background: tagInfo.color + '10' }}>
													<Icon icon={tagInfo.icon} size={14} className="tag-icon" style={{ color: tagInfo.color }} />
													<span class="tag-text">{tagInfo.tag}</span>
													<span class="tag-divider"></span>
													<span class="tag-category-label" style={{ color: tagInfo.color }}>{tagInfo.category}</span>
												</div>
											))}
										</div>
									</div>
								)}
								{estimated_time && (
									<div class="time-indicators">
										{estimated_time && (
											<div class="estimated-time-tag">
												<Icon icon="Clock" size={16} className="time-icon" />
												<span>{estimated_time} min project</span>
											</div>
										)}
										<div class="reading-time" id="reading-time-indicator">
											<Icon icon="BookOpen" size={16} className="time-icon" />
											<span id="reading-time-text">Calculating...</span>
										</div>
									</div>
								)}
							</div>
							<div class="markdown-content">
								<slot />
							</div>
						</div>
					</div>
				</div>
			</article>
		</main>
		<Footer />
		<script type="module" is:inline src={tableOfContentsScript}></script>
		<script type="module" is:inline src={headingAnchorsScript}></script>
		<script type="module" is:inline src={copyCodeScript}></script>
		<script is:inline>
			document.addEventListener('DOMContentLoaded', () => {
			  // Reading progress bar
			  const progressBar = document.getElementById('reading-progress');
			  
			  function updateReadingProgress() {
				  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
				  const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
				  const progress = (scrollTop / scrollHeight) * 100;
				  progressBar.style.width = progress + '%';
			  }
			  
			  window.addEventListener('scroll', updateReadingProgress);
			  updateReadingProgress();
			  
			  // Calculate reading time
			  const markdownContent = document.querySelector('.markdown-content');
			  if (markdownContent) {
			   const text = markdownContent.textContent || '';
			   const wordsPerMinute = 200;
			   const wordCount = text.trim().split(/\s+/).length;
			   const readingTime = Math.ceil(wordCount / wordsPerMinute);
			   
			   const readingTimeText = document.getElementById('reading-time-text');
			   if (readingTimeText) {
			    readingTimeText.textContent = `${readingTime} min read`;
			   }
			  }
			  
				});
		</script>
	</body>
</html>
