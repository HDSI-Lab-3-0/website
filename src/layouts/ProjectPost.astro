---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/layout/BaseHead.astro';
import Footer from '../components/layout/Footer.astro';
import FormattedDate from '../components/ui/FormattedDate.astro';
import Header from '../components/layout/Header.astro';
import { Icon } from '../components/ui/Icon.tsx';
import tagsData from '../data/tags.json';
import tableOfContentsScript from '../scripts/table-of-contents.js?url';
import headingAnchorsScript from '../scripts/heading-anchors.js?url';
import copyCodeScript from '../scripts/copy-code.js?url';

type Props = CollectionEntry<'projects'>['data'] & {
	showTitle?: boolean;
	showTOC?: boolean;
};

const { title, description, pubDate, updatedDate, imageGif, links, relevance, tags, estimated_time, sponsor, showTitle = true, showTOC = true } = Astro.props;

// Extract cost from tags
function getCostFromTags(projectTags: string[] | undefined): string | null {
	if (!projectTags) return null;
	const costTags = tagsData.categories.Cost || [];
	const cost = projectTags.find(tag => costTags.includes(tag));
	return cost || null;
}

// Get icon for each category
function getCategoryIcon(category: string): string {
	switch (category) {
		case 'Location':
			return 'MapPin';
		case 'School Level':
			return 'GraduationCap';
		case 'Sponsor':
			return 'Building';
		case 'Cost':
			return 'DollarSign';
		case 'Type':
			return 'Tag';
		default:
			return 'MoreHorizontal';
	}
}

// Get color for each category
function getCategoryColor(category: string): string {
	switch (category) {
		case 'Location':
			return '#10b981'; // emerald-500
		case 'School Level':
			return '#3b82f6'; // blue-500
		case 'Sponsor':
			return '#8b5cf6'; // violet-500
		case 'Cost':
			return '#f59e0b'; // amber-500
		case 'Type':
			return '#ef4444'; // red-500
		default:
			return '#6b7280'; // gray-500
	}
}

// Categorize tags based on tags.json
function categorizeTags(projectTags: string[] | undefined) {
	if (!projectTags || projectTags.length === 0) return {};
	
	const categorized: Record<string, string[]> = {};
	const usedTags = new Set<string>();
	
	// Check each tag against all categories
	for (const [category, categoryTags] of Object.entries(tagsData.categories)) {
		const matchingTags = projectTags.filter(tag =>
			categoryTags.some(catTag => catTag.toLowerCase() === tag.toLowerCase())
		);
		
		if (matchingTags.length > 0) {
			categorized[category] = matchingTags;
			matchingTags.forEach(tag => usedTags.add(tag.toLowerCase()));
		}
	}
	
	// Add remaining tags to "Other" category
	const otherTags = projectTags.filter(tag => !usedTags.has(tag.toLowerCase()));
	if (otherTags.length > 0) {
		categorized['Other'] = otherTags;
	}
	
	return categorized;
}

// Flatten all tags with their categories for unified display
function getAllTagsWithCategories(projectTags: string[] | undefined) {
	if (!projectTags || projectTags.length === 0) return [];
	
	const categorized = categorizeTags(projectTags);
	const allTags: Array<{ tag: string; category: string; icon: string; color: string }> = [];
	
	for (const [category, categoryTags] of Object.entries(categorized)) {
		for (const tag of categoryTags) {
			allTags.push({
				tag,
				category,
				icon: getCategoryIcon(category),
				color: getCategoryColor(category)
			});
		}
	}
	
	return allTags;
}

// Split sponsor by commas if present
const sponsorList = sponsor ? sponsor.split(',').map(s => s.trim()) : [];
const allTagsWithCategories = getAllTagsWithCategories(tags);

// Get primary tags (Location, School Level)
const primaryTags = allTagsWithCategories.filter(t =>
	t.category === 'Location' || t.category === 'School Level'
);

// Get secondary tags (Sponsor, Cost, Type, Other - excluding Location and School Level)
const secondaryTags = allTagsWithCategories.filter(t =>
	!['Location', 'School Level'].includes(t.category)
);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			/* New header styles */
			.text-muted {
				color: rgb(var(--gray));
			}

			/* Header layout */
			.project-header {
				text-align: left;
				padding-bottom: 0;
			}

			.header-metadata-row {
				margin-bottom: 0.5rem;
			}

			.header-title-row {
				gap: 1rem;
			}

			@media (max-width: 768px) {
				.header-title-row {
					flex-direction: column;
					gap: 1rem;
				}

				.header-actions {
					width: 100%;
					justify-content: flex-start;
				}
			}

			@media (max-width: 480px) {
				.header-actions {
					flex-direction: column;
					align-items: stretch;
				}

				.cta-primary,
				.cta-secondary {
					width: 100%;
					justify-content: center;
				}
			}

			/* Tag pills */
			.tag-pill {
				font-size: 0.8rem;
				padding: 0.35rem 0.85rem;
				cursor: pointer;
				border-radius: 6px;
				letter-spacing: 0.01em;
			}

			.tag-pill:hover {
				transform: translateY(-1px);
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}

			.tag-pill-secondary {
				font-size: 0.75rem;
				padding: 0.25rem 0.65rem;
				border-radius: 4px;
				color: rgba(var(--gray-dark), 0.7);
			}

			/* CTA buttons */
			.cta-primary {
				background: rgb(var(--accent));
				border: none;
			}

			.cta-primary:hover {
				background: rgba(var(--accent), 0.85);
			}

			.cta-secondary {
				background: transparent;
				border: 1px solid rgba(var(--gray), 0.3);
				transition: all 0.2s ease;
			}

			.cta-secondary:hover {
				background: rgba(var(--gray-light), 0.2);
			}

			/* Responsive layout adjustments */
			@media (min-width: 1200px) {
				.w-\[800px\] {
					width: 900px;
					padding: 2.5em 1.5em;
				}
			}
			
			@media (min-width: 1600px) {
				.w-\[800px\] {
					width: 1000px;
					padding: 3em 2em;
				}
			}
			
			@media (max-width: 1024px) {
				.flex.gap-12 {
					flex-direction: column;
					gap: 2rem;
					padding: 1.5rem 1rem;
				}
				
				.flex-shrink-0.w-\[250px\] {
					width: 100%;
					order: 1;
				}
				
				.flex-1.min-w-0.order-1 {
					order: -1;
				}
				
				.w-\[800px\] {
					padding: 1.5em 1em;
				}
			}
			
			@media (max-width: 768px) {
				.flex.gap-12 {
					padding: 1rem 0.5rem;
				}
				
				.w-\[800px\] {
					padding: 1em 0.5em;
				}
				
				.m-0.mb-3.text-\[2\.5rem\] {
					font-size: 2rem;
				}
			}
			
			@media (max-width: 480px) {
				.mb-8.pb-6 {
					padding: 1em 0;
					margin-bottom: 1.5em;
				}
				
				.m-0.mb-3.text-\[2\.5rem\] {
					font-size: 1.75rem;
				}
				
				.text-\[0\.75em\].opacity-70.uppercase.tracking-wider {
					display: none;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<!-- Reading Progress Bar -->
		<div class="reading-progress" id="reading-progress"></div>
		
		<main class="w-[calc(100%-2em)] max-w-full m-0">
			<article>
				<div class="flex gap-8 max-w-[1600px] mx-auto relative py-8 px-4">
					{showTOC && (
						<aside class="flex-shrink-0 w-[200px] -order-1">
							<div class="table-of-contents">
								<div class="toc-header">
									<span class="toc-title">Contents</span>
								</div>
								<div class="toc-content">
									<!-- Table of contents will be generated by JavaScript -->
								</div>
							</div>
						</aside>
					)}
					<div class="flex-1 min-w-0 order-1 overflow-hidden">
						<div class="w-full max-w-none mx-auto py-6 px-2 xtext-[rgb(var(--gray-dark))]">
							{imageGif && (
								<div class="w-full my-8">
									<Image width={1020} height={510} src={imageGif} alt="" class="block mx-auto rounded-xl shadow-[var(--box-shadow)]" />
								</div>
							)}
							{/* New header section */}
							<div class="project-header mb-8 text-center">
								

								{/* Title with CTA */}
								<div class="header-title-row mb-6">
									<div class="flex items-start justify-center">
										<h1 class="m-0 text-[2.5rem] leading-[1.2] text-[rgb(var(--black))]">{title}</h1>
										
									</div>
								</div>
								{/* Metadata row - Date, duration, cost */}
							<div class="header-metadata-row mb-2 text-center">
								<span class="text-muted text-xs font-medium">
									<FormattedDate date={pubDate} />
									{estimated_time && (
										<> · {estimated_time} min</>
									)}
									{secondaryTags.length > 0 && secondaryTags.find(t => t.category === 'Cost') && (
										<> · {secondaryTags.find(t => t.category === 'Cost')?.tag}</>
									)}
									{sponsorList.length > 0 && (
	<> · Sponsored by <span class="font-medium" style={{ color: '#8b5cf6' }}>{sponsorList.join(', ')}</span></>
)}
								</span>
							</div>

								{/* Primary tags - Location, School Level */}
								{primaryTags.length > 0 && (
									<div class="header-tags-primary mb-6">
										<div class="flex flex-wrap gap-3 justify-center">
											{primaryTags.map((tagInfo) => (
												<div
													class="tag-pill inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all hover:-translate-y-px hover:shadow-[0_2px_8px_rgba(0,0,0,0.1)]"
													style={{
														background: tagInfo.color + '15',
														border: `1px solid ${tagInfo.color}40`,
														color: tagInfo.color
													}}
												>
													<Icon icon={tagInfo.icon} size={14} className="opacity-70 flex-shrink-0" style={{ color: tagInfo.color }} />
													<span class="whitespace-nowrap">{tagInfo.tag}</span>
												</div>
											))}
										</div>
									</div>
								)}

								{/* Secondary tags - Sponsor, Cost, Type, Other (subtle) */}
								{secondaryTags.length > 0 && (
									<div class="header-tags-secondary">
										<div class="flex flex-wrap gap-2 justify-center">
											{secondaryTags.map((tagInfo) => (
												<div
													class="tag-pill-secondary inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all hover:bg-[rgba(var(--gray-light),0.25)]"
													style={{
														background: tagInfo.color + '08',
														border: `1px solid ${tagInfo.color}25`,
														color: 'rgba(var(--gray-dark),0.7)'
													}}
												>
													<Icon icon={tagInfo.icon} size={11} className="opacity-60 flex-shrink-0" style={{ color: tagInfo.color }} />
													<span class="whitespace-nowrap">{tagInfo.tag}</span>
												</div>
											))}
										</div>
									</div>
								)}

								{/* Relevance section */}
								{relevance && (
									<div class="my-8 p-5 bg-[rgba(var(--gray-light),0.1)] rounded-lg border border-[rgba(var(--gray-light),0.3)]">
										<h2 class="mt-0 mb-3 text-[1.1rem] font-semibold text-[rgb(var(--gray-dark))]">Relevance</h2>
										<p class="m-0 text-[rgb(var(--gray))] leading-[1.6]">{relevance}</p>
									</div>
								)}
							</div>

							</div>
							<div class="markdown-content">
								<slot />
							</div>
						</div>
					</div>
				</div>
			</article>
		</main>
		<Footer />
		{showTOC && <script type="module" is:inline src={tableOfContentsScript}></script>}
		<script type="module" is:inline src={headingAnchorsScript}></script>
		<script type="module" is:inline src={copyCodeScript}></script>
		<script is:inline define:vars={{ title }}>
			document.addEventListener('DOMContentLoaded', () => {
			  // Remove redundant H1 if it matches the page title
			  const markdownContent = document.querySelector('.markdown-content');
			  if (markdownContent) {
			    const firstH1 = markdownContent.querySelector('h1');
			    if (firstH1 && firstH1.textContent.trim().toLowerCase() === title.toLowerCase()) {
			      firstH1.remove();
			    }
			  }

			  // Reading progress bar
			  const progressBar = document.getElementById('reading-progress');
			  
			  function updateReadingProgress() {
				  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
				  const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
				  const progress = (scrollTop / scrollHeight) * 100;
				  progressBar.style.width = progress + '%';
			  }
			  
			  window.addEventListener('scroll', updateReadingProgress);
			  updateReadingProgress();
			  
			  // Calculate reading time
			  // Re-use markdownContent selector from above if possible, otherwise query again if scope issues prevent it.
			  // Since we are in the same block scope, we can just use the existing variable or check if it's null and query if needed, 
              // but here we just declared it above with const. 
              // The previous code had a second const declaration. We'll just use the existing one.
			  if (markdownContent) {
			   const text = markdownContent.textContent || '';
			   const wordsPerMinute = 200;
			   const wordCount = text.trim().split(/\s+/).length;
			   const readingTime = Math.ceil(wordCount / wordsPerMinute);
			   
			   const readingTimeText = document.getElementById('reading-time-text');
			   if (readingTimeText) {
			    readingTimeText.textContent = `${readingTime} min read`;
			   }
			  }
			  
				});
		</script>
	</body>
</html>
