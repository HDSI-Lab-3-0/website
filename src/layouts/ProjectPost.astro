---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/layout/BaseHead.astro';
import Footer from '../components/layout/Footer.astro';
import FormattedDate from '../components/ui/FormattedDate.astro';
import Header from '../components/layout/Header.astro';
import { Icon } from '../components/ui/Icon.tsx';
import tagsData from '../data/tags.json';
import tableOfContentsScript from '../scripts/table-of-contents.js?url';
import headingAnchorsScript from '../scripts/heading-anchors.js?url';
import copyCodeScript from '../scripts/copy-code.js?url';

type Props = CollectionEntry<'projects'>['data'] & {
	showTitle?: boolean;
	showTOC?: boolean;
};

const { title, description, pubDate, updatedDate, imageGif, links, relevance, tags, estimated_time, sponsor, showTitle = true, showTOC = true } = Astro.props;

// Get icon for each category
function getCategoryIcon(category: string): string {
	switch (category) {
		case 'Location':
			return 'MapPin';
		case 'School Level':
			return 'GraduationCap';
		case 'Sponsor':
			return 'Building';
		case 'Cost':
			return 'DollarSign';
		case 'Type':
			return 'Tag';
		default:
			return 'MoreHorizontal';
	}
}

// Get color for each category
function getCategoryColor(category: string): string {
	switch (category) {
		case 'Location':
			return '#10b981'; // emerald-500
		case 'School Level':
			return '#3b82f6'; // blue-500
		case 'Sponsor':
			return '#8b5cf6'; // violet-500
		case 'Cost':
			return '#f59e0b'; // amber-500
		case 'Type':
			return '#ef4444'; // red-500
		default:
			return '#6b7280'; // gray-500
	}
}

// Categorize tags based on tags.json
function categorizeTags(projectTags: string[] | undefined) {
	if (!projectTags || projectTags.length === 0) return {};
	
	const categorized: Record<string, string[]> = {};
	const usedTags = new Set<string>();
	
	// Check each tag against all categories
	for (const [category, categoryTags] of Object.entries(tagsData.categories)) {
		const matchingTags = projectTags.filter(tag =>
			categoryTags.some(catTag => catTag.toLowerCase() === tag.toLowerCase())
		);
		
		if (matchingTags.length > 0) {
			categorized[category] = matchingTags;
			matchingTags.forEach(tag => usedTags.add(tag.toLowerCase()));
		}
	}
	
	// Add remaining tags to "Other" category
	const otherTags = projectTags.filter(tag => !usedTags.has(tag.toLowerCase()));
	if (otherTags.length > 0) {
		categorized['Other'] = otherTags;
	}
	
	return categorized;
}

// Flatten all tags with their categories for unified display
function getAllTagsWithCategories(projectTags: string[] | undefined) {
	if (!projectTags || projectTags.length === 0) return [];
	
	const categorized = categorizeTags(projectTags);
	const allTags: Array<{ tag: string; category: string; icon: string; color: string }> = [];
	
	for (const [category, categoryTags] of Object.entries(categorized)) {
		for (const tag of categoryTags) {
			allTags.push({
				tag,
				category,
				icon: getCategoryIcon(category),
				color: getCategoryColor(category)
			});
		}
	}
	
	return allTags;
}

// Split sponsor by commas if present
const sponsorList = sponsor ? sponsor.split(',').map(s => s.trim()) : [];
const allTagsWithCategories = getAllTagsWithCategories(tags);
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
		<style>
			/* Responsive layout adjustments */
			@media (min-width: 1200px) {
				.w-\[800px\] {
					width: 900px;
					padding: 2.5em 1.5em;
				}
			}
			
			@media (min-width: 1600px) {
				.w-\[800px\] {
					width: 1000px;
					padding: 3em 2em;
				}
			}
			
			@media (max-width: 1024px) {
				.flex.gap-12 {
					flex-direction: column;
					gap: 2rem;
					padding: 1.5rem 1rem;
				}
				
				.flex-shrink-0.w-\[250px\] {
					width: 100%;
					order: 1;
				}
				
				.flex-1.min-w-0.order-1 {
					order: -1;
				}
				
				.w-\[800px\] {
					padding: 1.5em 1em;
				}
			}
			
			@media (max-width: 768px) {
				.flex.gap-12 {
					padding: 1rem 0.5rem;
				}
				
				.w-\[800px\] {
					padding: 1em 0.5em;
				}
				
				.m-0.mb-3.text-\[2\.5rem\] {
					font-size: 2rem;
				}
			}
			
			@media (max-width: 480px) {
				.mb-8.pb-6 {
					padding: 1em 0;
					margin-bottom: 1.5em;
				}
				
				.m-0.mb-3.text-\[2\.5rem\] {
					font-size: 1.75rem;
				}
				
				.text-\[0\.75em\].opacity-70.uppercase.tracking-wider {
					display: none;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<!-- Reading Progress Bar -->
		<div class="reading-progress" id="reading-progress"></div>
		
		<main class="w-[calc(100%-2em)] max-w-full m-0">
			<article>
				<div class="flex gap-12 max-w-[1400px] mx-auto relative py-8 px-4">
					{showTOC && (
						<aside class="flex-shrink-0 w-[250px] -order-1">
							<div class="table-of-contents">
								<div class="toc-header">
									<span class="toc-title">Contents</span>
								</div>
								<div class="toc-content">
									<!-- Table of contents will be generated by JavaScript -->
								</div>
							</div>
						</aside>
					)}
					<div class="flex-1 min-w-0 order-1 overflow-hidden">
						<div class="w-[1200px] max-w-[calc(100%-2em)] mx-auto py-8 xtext-[rgb(var(--gray-dark))]">
							{imageGif && (
								<div class="w-full my-10">
									<Image width={1020} height={510} src={imageGif} alt="" class="block mx-auto rounded-xl shadow-[var(--box-shadow)]" />
								</div>
							)}
							<div class="mb-8 pb-6 text-center leading-[1.2]">
								<div class="mb-3 text-[rgb(var(--gray))] text-[0.95rem] leading-[1.6]">
									<FormattedDate date={pubDate} />
									{
										updatedDate && (
											<div class="italic mt-2 text-[0.9rem]">
												Last updated on <FormattedDate date={updatedDate} />
											</div>
										)
									}
								</div>
								{showTitle && <h1 class="m-0 mb-3 text-[2.5rem] leading-[1.1]">{title}</h1>}
								<hr />
								{links && (links.lessonPlan || links.materials) && (
									<div class="my-8 p-6 bg-[rgba(var(--accent-light),0.1)] rounded-xl border border-[rgba(var(--accent),0.1)]">
										<h2 class="mt-0 mb-4 text-[1.3em] text-[rgb(var(--black))]">Resources</h2>
										<ul class="list-none p-0 m-0">
											{links.lessonPlan && (
												<li class="my-3">
													<a href={links.lessonPlan} target="_blank" rel="noopener noreferrer" class="text-[rgb(var(--accent))] no-underline hover:underline">
														<Icon icon="FileText" size={16} style={{ display: 'inline', marginRight: '0.5em' }} /> Lesson Plan
													</a>
												</li>
											)}
											{links.materials && (
												<li class="my-3 last:mb-0">
													<a href={links.materials} target="_blank" rel="noopener noreferrer" class="text-[rgb(var(--accent))] no-underline hover:underline">
														<Icon icon="Package" size={16} style={{ display: 'inline', marginRight: '0.5em' }} /> Materials
													</a>
												</li>
											)}
										</ul>
									</div>
								)}
								{relevance && (
									<div class="my-6 p-4 bg-[rgba(var(--gray-light),0.1)] rounded-lg italic">
										<h2 class="mt-0 text-[1.2em] not-italic">Relevance</h2>
										<p>{relevance}</p>
									</div>
								)}
								{sponsorList && sponsorList.length > 0 && (
									<div class="my-8 py-6 border-t border-[rgba(var(--gray-light),0.5)]">
										<div class="flex items-center mb-4 gap-2">
											<Icon icon="Building" size={20} className="flex-shrink-0" style={{ color: '#8b5cf6' }} />
											<h2 class="m-0 text-[1.25em] font-semibold text-[rgb(var(--gray-dark))]">Sponsor</h2>
										</div>
										<ul class="list-none p-0 m-0 flex flex-wrap gap-3">
											{sponsorList.map((s) => (
												<li class="inline-flex items-center gap-[0.4em] py-[0.5em] px-[0.9em] bg-[rgba(139,92,246,0.1)] border border-[rgba(139,92,246,0.3)] rounded-lg text-[0.95em] font-medium text-[rgb(var(--gray-dark))]">
													<span class="whitespace-nowrap">{s}</span>
												</li>
											))}
										</ul>
									</div>
								)}
								{allTagsWithCategories && allTagsWithCategories.length > 0 && (
									<div class="my-10 py-6 border-t border-[rgba(var(--gray-light),0.5)]">
										<div class="flex items-center mb-6 gap-2">
											<Icon icon="Tag" size={20} className="flex-shrink-0 opacity-80" style={{ color: 'rgb(var(--gray))' }} />
											<h2 class="m-0 text-[1.25em] font-semibold text-[rgb(var(--gray-dark))]">Tags</h2>
										</div>
										<div class="flex flex-wrap gap-3 mt-2">
											{allTagsWithCategories.map((tagInfo) => (
												<div class="inline-flex items-center gap-[0.4em] py-[0.4em] px-[0.9em] bg-[rgba(var(--gray-light),0.15)] border border-[rgba(var(--gray),0.15)] rounded-full text-[0.9em] font-medium text-[rgb(var(--gray-dark))] transition-all duration-200 hover:bg-[rgba(var(--gray-light),0.3)] hover:-translate-y-px hover:shadow-[0_2px_4px_rgba(var(--gray),0.1)]" style={{ borderColor: tagInfo.color + '40', background: tagInfo.color + '10' }}>
													<Icon icon={tagInfo.icon} size={14} className="flex-shrink-0 opacity-80" style={{ color: tagInfo.color }} />
													<span class="whitespace-nowrap">{tagInfo.tag}</span>
													<span class="w-px h-[1em] bg-[rgba(var(--gray),0.2)] mx-1"></span>
													<span class="text-[0.75em] opacity-70 uppercase tracking-wider" style={{ color: tagInfo.color }}>{tagInfo.category}</span>
												</div>
											))}
										</div>
									</div>
								)}
								{estimated_time && (
									<div class="my-6 flex flex-wrap gap-3 items-center">
										{estimated_time && (
											<div class="inline-flex items-center gap-[0.4em] py-2 px-4 bg-[rgba(var(--accent),0.1)] border border-[rgba(var(--accent),0.3)] rounded-full text-[0.9em] font-medium text-[var(--accent)] transition-all duration-200 hover:bg-[rgba(var(--accent),0.15)] hover:-translate-y-px hover:shadow-[0_2px_4px_rgba(var(--accent),0.2)]">
												<Icon icon="Clock" size={16} className="flex-shrink-0 opacity-90" />
												<span>{estimated_time} min project</span>
											</div>
										)}
										<div class="inline-flex items-center gap-[0.4em] py-2 px-4 bg-[rgba(var(--gray-light),0.15)] border border-[rgba(var(--gray),0.2)] rounded-full text-[0.9em] font-medium text-[rgb(var(--gray-dark))]" id="reading-time-indicator">
											<Icon icon="BookOpen" size={16} className="flex-shrink-0 opacity-90" />
											<span id="reading-time-text">Calculating...</span>
										</div>
									</div>
								)}
							</div>
							<div class="markdown-content">
								<slot />
							</div>
						</div>
					</div>
				</div>
			</article>
		</main>
		<Footer />
		{showTOC && <script type="module" is:inline src={tableOfContentsScript}></script>}
		<script type="module" is:inline src={headingAnchorsScript}></script>
		<script type="module" is:inline src={copyCodeScript}></script>
		<script is:inline>
			document.addEventListener('DOMContentLoaded', () => {
			  // Reading progress bar
			  const progressBar = document.getElementById('reading-progress');
			  
			  function updateReadingProgress() {
				  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
				  const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
				  const progress = (scrollTop / scrollHeight) * 100;
				  progressBar.style.width = progress + '%';
			  }
			  
			  window.addEventListener('scroll', updateReadingProgress);
			  updateReadingProgress();
			  
			  // Calculate reading time
			  const markdownContent = document.querySelector('.markdown-content');
			  if (markdownContent) {
			   const text = markdownContent.textContent || '';
			   const wordsPerMinute = 200;
			   const wordCount = text.trim().split(/\s+/).length;
			   const readingTime = Math.ceil(wordCount / wordsPerMinute);
			   
			   const readingTimeText = document.getElementById('reading-time-text');
			   if (readingTimeText) {
			    readingTimeText.textContent = `${readingTime} min read`;
			   }
			  }
			  
				});
		</script>
	</body>
</html>
